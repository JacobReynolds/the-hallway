<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <script defer data-domain="the-hallway.jakereynolds.co" src="https://metrics.jakereynolds.co/js/script.js"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="turbo-cache-control" content="no-cache" data-turbo-track="reload" data-track-token="3.5.0.761787093299">

    <!-- See retype.com -->
    <meta name="generator" content="Retype 3.5.0">

    <!-- Primary Meta Tags -->
    <title>a cdn?the-hallway</title>
    <meta name="title" content="a cdn?the-hallway">
    <meta name="description" content="why not?">

    <!-- Canonical -->
    <link rel="canonical" href="https://the-hallway.jakereynolds.co/cdn/">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://the-hallway.jakereynolds.co/cdn/">
    <meta property="og:title" content="a cdn?the-hallway">
    <meta property="og:description" content="why not?">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://the-hallway.jakereynolds.co/cdn/">
    <meta property="twitter:title" content="a cdn?the-hallway">
    <meta property="twitter:description" content="why not?">

    <script data-cfasync="false">(function () { var el = document.documentElement, m = localStorage.getItem("doc_theme"), wm = window.matchMedia; if (m === "dark" || (!m && wm && wm("(prefers-color-scheme: dark)").matches)) { el.classList.add("dark") } else { el.classList.remove("dark") } })();</script>

    <link href="../resources/css/retype.css?v=3.5.0.761787093299" rel="stylesheet">

    <script data-cfasync="false" src="../resources/js/config.js?v=3.5.0.761787093299" data-turbo-eval="false" defer></script>
    <script data-cfasync="false" src="../resources/js/retype.js?v=3.5.0" data-turbo-eval="false" defer></script>
    <script id="lunr-js" data-cfasync="false" src="../resources/js/lunr.js?v=3.5.0.761787093299" data-turbo-eval="false" defer></script>
</head>
<body>
    <div id="docs-app" class="relative text-base antialiased text-gray-700 bg-white font-body dark:bg-dark-850 dark:text-dark-300">
        <div class="absolute bottom-0 left-0 bg-gray-100 dark:bg-dark-800" style="top: 5rem; right: 50%"></div>
    
        <header id="docs-site-header" class="sticky top-0 z-30 flex w-full h-16 bg-white border-b border-gray-200 md:h-20 dark:bg-dark-850 dark:border-dark-650">
            <div class="container relative flex items-center justify-between pr-6 grow md:justify-start">
                <!-- Mobile menu button skeleton -->
                <button v-cloak class="skeleton docs-mobile-menu-button flex items-center justify-center shrink-0 overflow-hidden dark:text-white focus:outline-none rounded-full w-10 h-10 ml-3.5 md:hidden"><svg xmlns="http://www.w3.org/2000/svg" class="mb-px shrink-0" width="24" height="24" viewBox="0 0 24 24" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor"><path d="M2 4h20v2H2zM2 11h20v2H2zM2 18h20v2H2z"></path></g></svg></button>
                <div v-cloak id="docs-sidebar-toggle"></div>
        
                <!-- Logo -->
                <div class="flex items-center justify-between h-full py-2 md:w-75">
                    <div class="flex items-center px-2 md:px-6">
                        <a id="docs-site-logo" href="../" class="flex items-center leading-snug text-2xl">
                            <span class="dark:text-white font-semibold line-clamp-1 md:line-clamp-2">the-hallway</span>
                        </a>
                    </div>
        
                    <span class="hidden h-8 border-r md:inline-block dark:border-dark-650"></span>
                </div>
        
                <div class="flex justify-between md:grow">
                    <!-- Top Nav -->
                    <nav class="hidden md:flex">
                        <ul class="flex flex-col mb-4 md:pl-16 md:mb-0 md:flex-row md:items-center">
                            <li class="mr-6">
                                <a class="py-2 md:mb-0 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-blue-500 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200" href="https://github.com/jacobreynolds/the-hallway">Github</a>
                            </li>
        
                        </ul>
                    </nav>
        
                    <!-- Header Right Skeleton -->
                    <div v-cloak class="flex justify-end grow skeleton">
        
                        <!-- Search input mock -->
                        <div class="relative hidden w-40 lg:block lg:max-w-sm lg:ml-auto">
                            <div class="absolute flex items-center justify-center h-full pl-3 dark:text-dark-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon-base" width="16" height="16" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 1px;"><g fill="currentColor" ><path d="M21.71 20.29l-3.68-3.68A8.963 8.963 0 0020 11c0-4.96-4.04-9-9-9s-9 4.04-9 9 4.04 9 9 9c2.12 0 4.07-.74 5.61-1.97l3.68 3.68c.2.19.45.29.71.29s.51-.1.71-.29c.39-.39.39-1.03 0-1.42zM4 11c0-3.86 3.14-7 7-7s7 3.14 7 7c0 1.92-.78 3.66-2.04 4.93-.01.01-.02.01-.02.01-.01.01-.01.01-.01.02A6.98 6.98 0 0111 18c-3.86 0-7-3.14-7-7z" ></path></g></svg>
                            </div>
                            <input class="w-full h-10 placeholder-gray-400 transition-colors duration-200 ease-in bg-gray-200 border border-transparent rounded md:text-sm hover:bg-white hover:border-gray-300 focus:outline-none focus:bg-white focus:border-gray-500 dark:bg-dark-600 dark:border-dark-600 dark:placeholder-dark-400" style="padding: 0.625rem 0.75rem 0.625rem 2rem" type="text" placeholder="Search">
                        </div>
        
                        <!-- Mobile search button -->
                        <div class="flex items-center justify-center w-10 h-10 lg:hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="shrink-0 icon-base" width="20" height="20" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor" ><path d="M21.71 20.29l-3.68-3.68A8.963 8.963 0 0020 11c0-4.96-4.04-9-9-9s-9 4.04-9 9 4.04 9 9 9c2.12 0 4.07-.74 5.61-1.97l3.68 3.68c.2.19.45.29.71.29s.51-.1.71-.29c.39-.39.39-1.03 0-1.42zM4 11c0-3.86 3.14-7 7-7s7 3.14 7 7c0 1.92-.78 3.66-2.04 4.93-.01.01-.02.01-.02.01-.01.01-.01.01-.01.02A6.98 6.98 0 0111 18c-3.86 0-7-3.14-7-7z" ></path></g></svg>
                        </div>
        
                        <!-- Dark mode switch placeholder -->
                        <div class="w-10 h-10 lg:ml-2"></div>
        
                        <!-- History button -->
                        <div class="flex items-center justify-center w-10 h-10" style="margin-right: -0.625rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" class="shrink-0 icon-base" width="22" height="22" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor" ><g ><path d="M12.01 6.01c-.55 0-1 .45-1 1V12a1 1 0 00.4.8l3 2.22a.985.985 0 001.39-.2.996.996 0 00-.21-1.4l-2.6-1.92V7.01c.02-.55-.43-1-.98-1z"></path><path d="M12.01 1.91c-5.33 0-9.69 4.16-10.05 9.4l-.29-.26a.997.997 0 10-1.34 1.48l1.97 1.79c.19.17.43.26.67.26s.48-.09.67-.26l1.97-1.79a.997.997 0 10-1.34-1.48l-.31.28c.34-4.14 3.82-7.41 8.05-7.41 4.46 0 8.08 3.63 8.08 8.09s-3.63 8.08-8.08 8.08c-2.18 0-4.22-.85-5.75-2.4a.996.996 0 10-1.42 1.4 10.02 10.02 0 007.17 2.99c5.56 0 10.08-4.52 10.08-10.08.01-5.56-4.52-10.09-10.08-10.09z"></path></g></g></svg>
                        </div>
                    </div>
        
                    <div v-cloak class="flex justify-end grow">
                        <div id="docs-mobile-search-button"></div>
                        <doc-search-desktop></doc-search-desktop>
        
                        <doc-theme-switch class="lg:ml-2"></doc-theme-switch>
                        <doc-history></doc-history>
                    </div>
                </div>
            </div>
        </header>
    
        <div class="container relative flex bg-white">
            <!-- Sidebar Skeleton -->
            <div v-cloak class="fixed flex flex-col shrink-0 duration-300 ease-in-out bg-gray-100 border-gray-200 sidebar top-20 w-75 border-r h-screen md:sticky transition-transform skeleton dark:bg-dark-800 dark:border-dark-650">
            
                <!-- Render this div, if config.showSidebarFilter is `true` -->
                <div class="flex items-center h-16 px-6">
                    <input class="w-full h-8 px-3 py-2 transition-colors duration-200 ease-linear bg-white border border-gray-200 rounded shadow-none text-sm focus:outline-none focus:border-gray-600 dark:bg-dark-600 dark:border-dark-600" type="text" placeholder="Filter">
                </div>
            
                <div class="pl-6 mt-1 mb-4">
                    <div class="w-32 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                    <div class="w-48 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                    <div class="w-40 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                    <div class="w-32 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                    <div class="w-48 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                    <div class="w-40 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                </div>
            
                <div class="shrink-0 mt-auto bg-transparent dark:border-dark-650">
                    <a class="flex items-center justify-center flex-nowrap h-16 text-gray-400 dark:text-dark-400 hover:text-gray-700 dark:hover:text-dark-300 transition-colors duration-150 ease-in docs-powered-by" target="_blank" href="https://retype.com/" rel="noopener">
                        <span class="text-xs whitespace-nowrap">Powered by</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="ml-2" fill="currentColor" width="96" height="20" overflow="visible"><path d="M0 0v20h13.59V0H0zm11.15 17.54H2.44V2.46h8.71v15.08zM15.8 20h2.44V4.67L15.8 2.22zM20.45 6.89V20h2.44V9.34z"/><g><path d="M40.16 8.44c0 1.49-.59 2.45-1.75 2.88l2.34 3.32h-2.53l-2.04-2.96h-1.43v2.96h-2.06V5.36h3.5c1.43 0 2.46.24 3.07.73s.9 1.27.9 2.35zm-2.48 1.1c.26-.23.38-.59.38-1.09 0-.5-.13-.84-.4-1.03s-.73-.28-1.39-.28h-1.54v2.75h1.5c.72 0 1.2-.12 1.45-.35zM51.56 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92h4.74v1.83h-6.79V5.36h6.64zM60.09 7.15v7.48h-2.06V7.15h-2.61V5.36h7.28v1.79h-2.61zM70.81 14.64h-2.06v-3.66l-3.19-5.61h2.23l1.99 3.45 1.99-3.45H74l-3.19 5.61v3.66zM83.99 6.19c.65.55.97 1.4.97 2.55s-.33 1.98-1 2.51-1.68.8-3.04.8h-1.23v2.59h-2.06V5.36h3.26c1.42 0 2.45.28 3.1.83zm-1.51 3.65c.25-.28.37-.69.37-1.22s-.16-.92-.48-1.14c-.32-.23-.82-.34-1.5-.34H79.7v3.12h1.38c.68 0 1.15-.14 1.4-.42zM95.85 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92H96v1.83h-6.79V5.36h6.64z"/></g></svg>
                    </a>
                </div>
            </div>
            
            <!-- Sidebar component -->
            <doc-sidebar v-cloak>
                <template #sidebar-footer>
                    <div class="shrink-0 mt-auto border-t md:bg-transparent md:border-none dark:border-dark-650">
            
                        <div class="py-3 px-6 md:hidden border-b dark:border-dark-650">
                            <nav>
                                <ul class="flex flex-wrap justify-center items-center">
                                    <li class="mr-6">
                                        <a class="block py-1 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-blue-500 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200" href="https://github.com/jacobreynolds/the-hallway">Github</a>
                                    </li>
            
                                </ul>
                            </nav>
                        </div>
            
                        <a class="flex items-center justify-center flex-nowrap h-16 text-gray-400 dark:text-dark-400 hover:text-gray-700 dark:hover:text-dark-300 transition-colors duration-150 ease-in docs-powered-by" target="_blank" href="https://retype.com/" rel="noopener">
                            <span class="text-xs whitespace-nowrap">Powered by</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="ml-2" fill="currentColor" width="96" height="20" overflow="visible"><path d="M0 0v20h13.59V0H0zm11.15 17.54H2.44V2.46h8.71v15.08zM15.8 20h2.44V4.67L15.8 2.22zM20.45 6.89V20h2.44V9.34z"/><g><path d="M40.16 8.44c0 1.49-.59 2.45-1.75 2.88l2.34 3.32h-2.53l-2.04-2.96h-1.43v2.96h-2.06V5.36h3.5c1.43 0 2.46.24 3.07.73s.9 1.27.9 2.35zm-2.48 1.1c.26-.23.38-.59.38-1.09 0-.5-.13-.84-.4-1.03s-.73-.28-1.39-.28h-1.54v2.75h1.5c.72 0 1.2-.12 1.45-.35zM51.56 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92h4.74v1.83h-6.79V5.36h6.64zM60.09 7.15v7.48h-2.06V7.15h-2.61V5.36h7.28v1.79h-2.61zM70.81 14.64h-2.06v-3.66l-3.19-5.61h2.23l1.99 3.45 1.99-3.45H74l-3.19 5.61v3.66zM83.99 6.19c.65.55.97 1.4.97 2.55s-.33 1.98-1 2.51-1.68.8-3.04.8h-1.23v2.59h-2.06V5.36h3.26c1.42 0 2.45.28 3.1.83zm-1.51 3.65c.25-.28.37-.69.37-1.22s-.16-.92-.48-1.14c-.32-.23-.82-.34-1.5-.34H79.7v3.12h1.38c.68 0 1.15-.14 1.4-.42zM95.85 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92H96v1.83h-6.79V5.36h6.64z"/></g></svg>
                        </a>
                    </div>
                </template>
            </doc-sidebar>
    
            <div class="grow min-w-0 dark:bg-dark-850">
                <!-- Render "toolbar" template here on api pages --><!-- Render page content -->
                <div class="flex">
                    <div class="min-w-0 p-4 grow md:px-16">
                        <main class="relative pb-12 lg:pt-2">
                            <div class="docs-markdown" id="docs-content">
                                <!-- Rendered if sidebar right is enabled -->
                                <div id="docs-sidebar-right-toggle"></div>
                                <!-- Page content  -->
<doc-anchor-target id="-cdn" class="break-words">
    <h1>
        <doc-anchor-trigger class="header-anchor-trigger" to="#-cdn">#</doc-anchor-trigger>
        <span>🛜 CDN</span>
    </h1>
</doc-anchor-target>
<p>Not exactly a CDN, more of a WAAP, but anytime I say WAAP people starting singing Cardi B lyrics at me. WAAP stands for Web Application and API Protection. The common example would be <a href="https://www.cloudflare.com/">Cloudflare</a>, but more closely would be <a href="https://www.imperva.com/">Imperva</a> and <a href="https://www.akamai.com/">Akamai</a>. These platforms proxy all of your traffic and perform DDOS protection, bot mitigation, web firewall rule matching, API inventorying, and more. Similar in grandiose size to <a href="../bank/">a bank</a>, but far more in my wheelhouse. At this point I&#x27;m about 4 weeks into my start up journey and am getting a bit sick of cold outreach on LinkedIn, so I decided to grace myself with a little technical research. I knew there was a market for this, I wasn&#x27;t quite sure what my differentiator would be, but I wanted to see if I could get the basic concepts built first to recharge my batteries a bit.</p>
<p>To give you an introduction to what I built, these two diagrams can be pretty helpful and are explained below.</p>
<details>
  <summary>Infrastructure Diagram</summary>
  <img src="./arch.png">
</details>
<details>
  <summary>WAF Request Lifecycle</summary>
  <img src="./lifecycle.png">
</details>
<doc-anchor-target id="cheap-af">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#cheap-af">#</doc-anchor-trigger>
        <span>Cheap AF</span>
    </h2>
</doc-anchor-target>
<p>So an edge network that can intercept traffic across the globe, cache it, inspect it, or whatever it, and then forward it to the destination server. That means aside from compute, our largest cost is likely going to be <a href="https://getdeploying.com/reference/data-egress">network egress fees</a>, and as that link shows, it&#x27;s not cheap. If you&#x27;re looking at using AWS, your egress costs are 9.2x what they&#x27;d be on something like Digital Ocean. From the good ol&#x27; days when I was building a <a href="../cloud-security/">cloud security</a> company, I remembered Hetzner and OVHcloud, and their pricing seemed great for egress. After further inspection though they don&#x27;t have a very large global presence. Hetzner is mostly central Europe and OVHcloud had a lot of locations but <a href="https://us.ovhcloud.com/public-cloud/regions-availability/">limited support</a> for various features of their platform (like cheap computing plans) across those regions.</p>
<p>After some bouncing around, Digital Ocean (DO) seemed to be the best contender. I&#x27;d used it in the past, they have cute marketing, and had a good blend between global coverage and cheap egress fees.</p>
<doc-anchor-target id="can-you-hear-me-now">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#can-you-hear-me-now">#</doc-anchor-trigger>
        <span>Can you hear me now?</span>
    </h2>
</doc-anchor-target>
<p>The next hurdle was to try and build a network of servers around the world that could communicate with each other and proxy traffic. My brain immediately goes to Kubernetes (k8s). I use to manage a cluster in my last job, which thankfully we migrated off of, and am somewhat familiar with it. (Spoiler alert: he wasn&#x27;t familiar enough with it). There are a lot of options for managing k8s:</p>
<ul>
<li>you can <a href="https://kubernetes.io/docs/setup/production-environment/">raw dog it</a> by yourself</li>
<li>use a managed service like <a href="https://aws.amazon.com/eks/">EKS</a> or <a href="https://cloud.google.com/Kubernetes-engine?hl=en">GKE</a></li>
<li>use some of the enterprise managers like <a href="https://www.rancher.com/">Rancher</a></li>
</ul>
<p>There are also some fun options like <a href="https://k3s.io/">k3s</a> and its variants that give you a simplified method to install k8s. I took a brief look at <a href="https://www.nomadproject.io/">Nomad</a> but the ecosystem sadly isn&#x27;t robust enough for me to feel comfortable adopting it, but they do have <a href="https://developer.hashicorp.com/nomad/tutorials/manage-clusters/federation">multi-region federation</a> which is more than I can say for k8s, whose federation seems to be <a href="https://groups.google.com/g/kubernetes-sig-multicluster/c/lciAVj-_ShE">eternally in beta</a>.</p>
<p>It turns out, choosing k8s despite not having multi-region federation was going to be a problem. Follow along with my stupidity that wasted 2 days. I decided not to use Digital Ocean&#x27;s managed k8s because it only supports deploying the cluster in a single region (hmmm...I wonder why they do that...). So I opted to use <a href="https://docs.rke2.io/">Rancher Kubernetes Engine 2</a> (RKE2) since I could control how to deploy the nodes. I spun up worker nodes in DO&#x27;s New York City (NYC), Amsterdam (AMS), and Sydney (SYD) regions and deployed a simple http server into them.</p>
<doc-anchor-target id="how-about-now">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#how-about-now">#</doc-anchor-trigger>
        <span>How about now?</span>
    </h3>
</doc-anchor-target>
<p>Cool, so I have a k8s cluster running across multiple regions, but now I need to figure out how to route traffic to different regions based on geographic location. You have 2 options when doing this, one is lease a /24 IPV4 range, bring it to a cloud provider, and broadcast it via BGP Anycast on nodes around the world (something DO doesn&#x27;t support, btw...). You can see a good overview of Anycast <a href="https://www.imperva.com/blog/how-anycast-works/">here</a> if you&#x27;re interested. The other option is using <a href="https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/routing-policy-geo.html">GeoDNS</a> which lets you serve different DNS records based on the location of the user, or their proximity to your servers. That seems way simpler, albeit less robust. I threw in some records and pointed them at my hosts.</p>
<doc-anchor-target id="now">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#now">#</doc-anchor-trigger>
        <span>...now?</span>
    </h3>
</doc-anchor-target>
<p>Finally, I can try and see if they can hear me. I send a request on my test network to <a href="https://dev.mistysec.com">https://dev.mistysec.com</a> and.................timeout. What the fuck, dude?! I actually don&#x27;t know why it took me this long to get around to testing the web server, but I wanted to get over the DNS hurdle and didn&#x27;t expect an issue here at all. I&#x27;ll save you the day of debugging I did and cut to the end, basically k8s isn&#x27;t built to have its nodes geographically dispersed. Even if I send an HTTP request directly to an ingress node in NYC, it will still sometimes communicate with the node in AMS to see if it can handle the request. And occasionally, it&#x27;ll also route the request over there. They don&#x27;t really make any promises, or give you any (easy) controls, for routing traffic based on geolocation. And the options they do give you don&#x27;t remove the latency at the control plane.</p>
<doc-anchor-target id="switching-to-mint-mobile">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#switching-to-mint-mobile">#</doc-anchor-trigger>
        <span>Switching to Mint Mobile</span>
    </h2>
</doc-anchor-target>
<p>Well that sucks. One thing that has always bothered me about k8s is that it&#x27;s got a ton going on inside of it, a lot I don&#x27;t know about, and definitely don&#x27;t know how to fix. So I tried to strip my requirements down to the bare minimum and see if I could build what I needed from scratch. I would need:</p>
<ul class="contains-task-list">
<li class="task-list-item"><input disabled="disabled" type="checkbox" /> A service mesh, so the servers can communicate with each other. For example, to retrieve the SSL/TLS cert for a host to decrypt its traffic</li>
<li class="task-list-item"><input disabled="disabled" type="checkbox" /> The ability to push containers to edge nodes and routinely update them</li>
<li class="task-list-item"><input disabled="disabled" type="checkbox" /> A private network for this communication to happen across</li>
</ul>
<doc-anchor-target id="what-the-fuck-is-a-kilometer">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#what-the-fuck-is-a-kilometer">#</doc-anchor-trigger>
        <span>What the fuck is a kilometer?</span>
    </h2>
</doc-anchor-target>
<p>Okay, so, a service mesh? I could probably drop this phrase in a conversation in silicon valley and get away with it, but I really had no idea what it was. Still don&#x27;t. But at my base understanding, it&#x27;s a way for a group of servers to discover and communicate with each other. <a href="https://istio.io/latest/about/service-mesh/">Istio</a> is a popular example for how this is handled in k8s. I spent awhile researching, and wish I remembered all the weird things I looked at, but at the end of the day I ran into <a href="https://nats.io/">NATS</a> which is a streaming and message passing platform (and also a lot more). Think Kafka, but sexier. This means I could have a NATS server in each region of my cluster, and then the edge nodes only need to connect to their local server. From there, they communicate with other servers via message subjects, e.g. <code v-pre>acme.getCertificate</code>, instead of needing to know their IP/Domain name. The servers then form a <a href="https://docs.nats.io/running-a-nats-service/configuration/clustering">regional cluster</a> and a global <a href="https://docs.nats.io/running-a-nats-service/configuration/gateways">super-cluster</a> and handle passing messages across the architecture. Long story short this means aside from the NATS servers, all my other servers only need to communicate with hosts in their region. And the NATS servers handle cross-region communication and private networking. Side note: they have a sweet piece of tech called <a href="https://nats.io/blog/introducing_nex/">nex</a> coming out, that I wanted to use for my distributed containers here, but it was a bit too early in their alpha for my uses.</p>
<p>Alright, so all the servers can communicate, but it doesn&#x27;t seem great to have them doing that over the public internet? NATS seems secure, but you really shouldn&#x27;t be publicly exposing these ports.</p>
<blockquote class="note-title" :="">
<p>Now, I know, at this point you&#x27;re saying: &quot;Jake who fucking cares if it&#x27;s secure? You have no customers&quot;. And to that I would say...touché</p>
</blockquote>
<doc-anchor-target id="en-garde">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#en-garde">#</doc-anchor-trigger>
        <span>En Garde</span>
    </h2>
</doc-anchor-target>
<p>In some cases, your service mesh will also handle securing your communication, and honestly one could argue using NATS with TLS would be secure enough as well, but what if I also want to do non-NATS things on this network? I looked at a couple commercial options, like <a href="https://tailscale.com/">Tailscale</a>, but didn&#x27;t find any that you could deploy entirely yourself. I didn&#x27;t want to use Digital Ocean VPCs because if this thing grows I&#x27;ll likely move it to bare metal hosting with another provider and don&#x27;t want to rewrite the networking. I ended up going with <a href="https://www.wireguard.com/">Wireguard</a> for a couple reasons:</p>
<ul>
<li>It supports peer-to-peer connections, so I don&#x27;t need a massive global network</li>
<li>There is a <a href="https://github.com/WireGuard/wireguard-go">user-space golang library</a> (I wouldn&#x27;t know this until later...)</li>
<li>Fully open-source and easy to deploy on-prem</li>
</ul>
<doc-anchor-target id="a-brief-aside">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#a-brief-aside">#</doc-anchor-trigger>
        <span>A brief aside</span>
    </h2>
</doc-anchor-target>
<p>Something I haven&#x27;t mentioned yet is how I&#x27;m handling all this infrastructure. In simple terms, I&#x27;m using <a href="https://www.pulumi.com/">Pulumi</a> with <a href="https://www.pulumi.com/registry/packages/command/api-docs/remote/command/">Remote Commands</a> as a pseudo-ansible to handle any resource provisioning after the VM starts up (e.g. deploying a new docker container, updating wireguard routes).</p>
<doc-anchor-target id="back-at-it">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#back-at-it">#</doc-anchor-trigger>
        <span>Back at it</span>
    </h2>
</doc-anchor-target>
<p>So I updated Pulumi to install wireguard with the base <a href="https://cloud-init.io/">cloud-init</a> configuration for all my servers, and added remote commands to add new peers as they are spun up. This is sick! My grand plan is all coming together. Now all I have to do is take my central control server, which runs next to my web server, and connect it to wireguard so it can send commands to the NATS cluster. One part I haven&#x27;t mentioned is that I have a web application for typical user-facing stuff and a control server, which handles communications between the web server and the edge network. This is hosted on Digital Ocean as well, using their App Platform. I updated the code for the control server to add wireguard&#x27;s <a href="https://github.com/WireGuard/wireguard-go">userspace library</a> and deploy it. <code v-pre>err: Unable to update bind</code>. <span class="docs-emoji">&#x1F92C;</span>. After another few hours of exploring it seems that most container platforms don&#x27;t allow you to do a lot with the network settings of the container, even though this one should be entirely user space. You typically need to add something like <code v-pre>--cap-add=NET_ADMIN</code> to your <code v-pre>docker run</code> command to make it work. Annoyingly, even if I stripped my local docker containers of all permissions I couldn&#x27;t replicate the same error, which made debugging hard. I looked at a lot of workarounds and solutions and could not find anything that would work.</p>
<p>I tried deploying the same docker container on <a href="https://render.com">Render</a> and got the same issue. Luckily though, they also support <a href="https://docs.render.com/native-runtimes">Native Runtimes</a> which for some reason don&#x27;t have the same issues with network capabilities. I had already had some other annoying experiences with DO&#x27;s App Platform at this point, so I moved over to Render and everything was happy.</p>
<doc-anchor-target id="time-to-spy">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#time-to-spy">#</doc-anchor-trigger>
        <span>Time to spy</span>
    </h2>
</doc-anchor-target>
<p>I updated my simple web UI to allow a user to provide a domain name and a host they want to proxy it to, it would then verify the DNS points to our GeoDNS location and start proxying. When a request comes into an Edge Agent, it would send a NATS request to the control server asking for the proxy settings of that host, and would then use those settings to route the request accordingly. But the internet doesn&#x27;t run on port 80, so we have to deal with TLS certificates. <a href="https://letsencrypt.org/">Let&#x27;s encrypt</a> is the popular option here, so I began looking into how to programmatically work with it. I looked at some libraries for this, but none gave me the control and flexibility I wanted, So I decided to implement my own lightweight <a href="https://datatracker.ietf.org/doc/html/rfc8555">ACME client</a>. I followed <a href="https://github.com/alexpeattie/letsencrypt-fromscratch">this awesome guide</a>, but it was written in Ruby and I was currently using typescript in the control server. A little ChatGPT later and I have that guide converted to typescript. The timelines here aren&#x27;t exactly chronological, I actually did this before I ran into the wireguard issues outlined above. So when I ran into those issues I migrated the control server from typescript to golang, so I could use the userspace wireguard library. With that, I used ChatGPT to convert my typescript ACME client to golang. A bastardization that should never see the light of day.</p>
<p>After some tinkering, I was able to get the certificates provisioned and communicating through NATS. Now when a request came into the Edge Agent (Go Gin web server) it would intercept the SSL/TLS handshake, get the SNI from the Client Hello message, reach out via NATS to the control server and ask for the TLS certificate, and return it to the requesting client. After the handshake completed, the agent would ask for the proxy configuration, and forward the requests along to their destination host.</p>
<doc-anchor-target id="ready-aim-firewall">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#ready-aim-firewall">#</doc-anchor-trigger>
        <span>Ready, aim, firewall!</span>
    </h2>
</doc-anchor-target>
<p>Everything&#x27;s hunky dory, intercepting and proxying TLS requests across the globe, but what&#x27;s a WAAP without a wet ass...I mean a web app firewall. I originally thought about throwing out NGINX with <a href="https://owasp.org/www-project-modsecurity-core-rule-set/">ModSecurity CRS</a> on it and calling it a day, but as always I wasn&#x27;t able to achieve the customization I wanted out of it. Luckily for me, I found <a href="https://coraza.io/">Coraza</a> which is a rewrite of Modsecurity in golang. More luckily, it&#x27;s also usable as a <em>library</em> in go. Plugged that into our web server, messed around with some configurations, and we were now globally scrubbing malicious requests before they ever reach our destination server.</p>
<p>That wasn&#x27;t so hard...was it? It only took two weeks of insanity and tearing my hair out, but hey, we got there.</p>
<doc-anchor-target id="uff-da">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#uff-da">#</doc-anchor-trigger>
        <span>Uff da</span>
    </h2>
</doc-anchor-target>
<p>Yeah that was a lot. Honestly I&#x27;d open source the code, but it&#x27;s mostly garbage. If you&#x27;re interested in looking at it, shoot me an email at <a href="mailto:me@jakereynolds.co">me@jakereynolds.co</a>. I went on to do some user research after this and when talking with users, it seems that WAFs are mostly commoditized and no one wants to proxy their prod traffic through a network that isn&#x27;t cloudflare scale. I kind of had that expectation going into this, but I think there&#x27;s a lot of components from this research that I&#x27;ll be able to reuse in other projects.</p>
<doc-anchor-target id="thanks-for-reading">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#thanks-for-reading">#</doc-anchor-trigger>
        <span>Thanks for reading!</span>
    </h2>
</doc-anchor-target>

                                
                                <!-- Required only on API pages -->
                                <doc-toolbar-member-filter-no-results></doc-toolbar-member-filter-no-results>
                            </div>
                            <footer class="clear-both">
                            
                                <nav class="flex mt-14">
                                    <div class="w-1/2">
                                        <a class="px-5 py-4 h-full flex items-center break-normal font-medium text-blue-500 dark:text-blue-400 border border-gray-300 hover:border-gray-400 dark:border-dark-650 dark:hover:border-dark-450 rounded-l-lg transition-colors duration-150 relative hover:z-5" href="../bank/">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="mr-3" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M19 11H7.41l5.29-5.29a.996.996 0 10-1.41-1.41l-7 7a1 1 0 000 1.42l7 7a1.024 1.024 0 001.42-.01.996.996 0 000-1.41L7.41 13H19c.55 0 1-.45 1-1s-.45-1-1-1z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
                                            <span>
                                                <span class="block text-xs font-normal text-gray-400 dark:text-dark-400">Previous</span>
                                                <span class="block mt-1">a bank?</span>
                                            </span>
                                        </a>
                                    </div>
                            
                                    <div class="w-1/2">
                                        <a class="px-5 py-4 -mx-px h-full flex items-center justify-end break-normal font-medium text-blue-500 dark:text-blue-400 border border-gray-300 hover:border-gray-400 dark:border-dark-650 dark:hover:border-dark-450 rounded-r-lg transition-colors duration-150 relative hover:z-5" href="../cookie/">
                                            <span>
                                                <span class="block text-xs font-normal text-right text-gray-400 dark:text-dark-400">Next</span>
                                                <span class="block mt-1">cookie</span>
                                            </span>
                                            <svg xmlns="http://www.w3.org/2000/svg" class="ml-3" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M19.92 12.38a1 1 0 00-.22-1.09l-7-7a.996.996 0 10-1.41 1.41l5.3 5.3H5c-.55 0-1 .45-1 1s.45 1 1 1h11.59l-5.29 5.29a.996.996 0 000 1.41c.19.2.44.3.7.3s.51-.1.71-.29l7-7c.09-.09.16-.21.21-.33z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
                                        </a>
                                    </div>
                                </nav>
                            </footer>
                        </main>
                
                        <div class="border-t dark:border-dark-650 pt-6 mb-8">
                            <footer class="flex flex-wrap items-center justify-between">
                                <div>
                                    <ul class="flex flex-wrap items-center text-sm">
                                    </ul>
                                </div>
                                <div class="docs-copyright py-2 text-gray-500 dark:text-dark-350 text-sm leading-relaxed"><p>© Copyright 2024. All rights reserved.</p></div>
                            </footer>
                        </div>
                    </div>
                
                    <!-- Rendered if sidebar right is enabled -->
                    <!-- Sidebar right skeleton-->
                    <div v-cloak class="fixed top-0 bottom-0 right-0 translate-x-full bg-white border-gray-200 lg:sticky lg:border-l lg:shrink-0 lg:pt-6 lg:transform-none sm:w-1/2 lg:w-64 lg:z-0 md:w-104 sidebar-right skeleton dark:bg-dark-850 dark:border-dark-650">
                        <div class="pl-5">
                            <div class="w-32 h-3 mb-4 bg-gray-200 dark:bg-dark-600 rounded-full loading"></div>
                            <div class="w-48 h-3 mb-4 bg-gray-200 dark:bg-dark-600 rounded-full loading"></div>
                            <div class="w-40 h-3 mb-4 bg-gray-200 dark:bg-dark-600 rounded-full loading"></div>
                        </div>
                    </div>
                
                    <!-- User should be able to hide sidebar right -->
                    <doc-sidebar-right v-cloak></doc-sidebar-right>
                </div>

            </div>
        </div>
    
        <doc-search-mobile></doc-search-mobile>
        <doc-back-to-top></doc-back-to-top>
    </div>


    <div id="docs-overlay-target"></div>

    <script data-cfasync="false">window.__DOCS__ = { "title": "a cdn?", level: 1, icon: "file", hasPrism: false, hasMermaid: false, hasMath: false, tocDepth: 23 }</script>
</body>
</html>
